---

title: Workflow


keywords: fastai
sidebar: home_sidebar

summary: "Define static or dynamic workflow for automatically updating, training and deploying your ML model!"
description: "Define static or dynamic workflow for automatically updating, training and deploying your ML model!"
nb_path: "03_workflow.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 03_workflow.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><strong><em>input:</em></strong> Workflow definition parameters</p>
<p><strong><em>output:</em></strong> python or snakemake script for running the workflow</p>
<p><strong><em>description:</em></strong></p>
<p>While you are developing your ML application, you might prefer running the notebooks manually again and again.
However, once you have deployed your model into production it becomes unpractical and compromizes scalability, modularity and the principle of ease of reproducibility.
This happens regardless of what 'production' means to you - it might well be that you are just running the notebooks and viewing the results directly from them.
Whatever you are doing, having a single command to run the whole workflow makes things so much easier.</p>
<p>In this notebook we explain alternatives for automating workflows, either as a static or dynamic. 
By following these examples (and further documentation on <a href="https://papermill.readthedocs.io/">papermill</a> and <a href="https://snakemake.readthedocs.io/">Snakemake</a>) you can parameterize your notebooks,
run them automatically in a workflow, and even parameterize and automate the workflow definition.
With this template, you can easily define very complex and versatile workflows, that are well documented in a notebook.</p>
<p>We selected these tools for the template because they have stable community support, they are relatively easy to use and they fit our needs.
There are also other tools for workflow management and orchestration that may better suite your needs. Feel free to use them.
For more information, see for example this 
<a href="https://medium.com/@Minyus86/comparison-of-pipeline-workflow-packages-airflow-luigi-gokart-metaflow-kedro-pipelinex-5daf57c17e7">comparison of workflow tools for Python</a>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Import-relevant-modules">Import relevant modules<a class="anchor-link" href="#Import-relevant-modules"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">papermill</span> <span class="k">as</span> <span class="nn">pm</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Define-notebook-parameters">Define notebook parameters<a class="anchor-link" href="#Define-notebook-parameters"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered celltag_parameters">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">save_notebooks_to</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">&quot;results/.notebooks/&quot;</span>  <span class="c1"># TODO: make example of timestamping notebook runs</span>
<span class="p">)</span>

<span class="c1">## NOTE: copies of executed notebooks are saved to hidden folder, because currently nbdev searches</span>
<span class="c1">## all subfolders when building docs, and the notebook copies may cause confusing results.</span>
<span class="c1">## hidden folders should be ignored.</span>
<span class="c1">## See more: https://github.com/fastai/nbdev/issues/357</span>
<span class="c1">## TODO: follow updates on nbdev, see if there is a cleaner fix to this!</span>

<span class="c1"># notebook names</span>
<span class="n">data</span> <span class="o">=</span> <span class="s2">&quot;00_data.ipynb&quot;</span>
<span class="n">data_params</span> <span class="o">=</span> <span class="p">{}</span>

<span class="n">model</span> <span class="o">=</span> <span class="s2">&quot;01_model.ipynb&quot;</span>
<span class="n">model_params</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;seed&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>

<span class="n">loss</span> <span class="o">=</span> <span class="s2">&quot;02_loss.ipynb&quot;</span>
<span class="n">loss_params</span> <span class="o">=</span> <span class="p">{}</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>make direct derivations from the paramerters:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Custom-magic-function-to-write-code-cell-contents-to-a-file-with-global-variables-formatted:">Custom magic function to write code cell contents to a file with global variables formatted:<a class="anchor-link" href="#Custom-magic-function-to-write-code-cell-contents-to-a-file-with-global-variables-formatted:"> </a></h2><p>This is needed so that we can create parameterizable non-python scripts from inside a notebook.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">IPython.core.magic</span> <span class="kn">import</span> <span class="n">register_line_cell_magic</span>


<span class="nd">@register_line_cell_magic</span>
<span class="k">def</span> <span class="nf">writefile_format_globals</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">cell</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is a function to write contents of a notebook cell to a file.</span>
<span class="sd">    To use it, call &#39;%%writefile_format_globals filename&#39; in the first row of</span>
<span class="sd">    the cell the contents of which you want to write into a file.</span>
<span class="sd">    The code written in this cell is not run in the notebook.</span>
<span class="sd">    This means that you can also write and define non-python scripts and</span>
<span class="sd">    execute them from a notebook.</span>

<span class="sd">    You can format in global variables by placing them inside curly</span>
<span class="sd">    brackets &#39;{variable name}&#39;.</span>

<span class="sd">    Note, that your code should not include curly brackets.</span>
<span class="sd">    If curly brackets need to be written in the file, you can include</span>
<span class="sd">    them through the variable insertion:</span>

<span class="sd">    ## CELL 1:</span>
<span class="sd">    bracket_open_string = &#39;{&#39;</span>
<span class="sd">    bracket_close_string = &#39;}&#39;</span>

<span class="sd">    ## CELL 2:</span>
<span class="sd">    %write_format_globals myscriptname</span>
<span class="sd">    {bracket_open_string}</span>
<span class="sd">        # I want this part inside curly brackets!</span>
<span class="sd">    {bracket_close_string}</span>

<span class="sd">    ## file &#39;myscriptname&#39; after running the cells 1 and 2:</span>
<span class="sd">    {</span>
<span class="sd">        # I want this part inside curly brackets!</span>
<span class="sd">    }</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="nb">globals</span><span class="p">()))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="How-to-run-parameterized-notebooks-with-papermill">How to run parameterized notebooks with papermill<a class="anchor-link" href="#How-to-run-parameterized-notebooks-with-papermill"> </a></h2><p>Papermill allows parameterizing and running notebooks from Python runtime with <code>papermill.execute_notebook(input, output, parameters)</code>.
The <code>input</code> parameter is the notebook to be run. The <code>output</code> parameter is the filepath where copy of the executed notebook is saved with the results.
This can be the same as the <code>input</code>, but you probably want to keep it separate - otherwise your version control may get messy. 
In this example executed notebooks are saved under <code>results/notebooks</code>. The <code>parameters</code> cell allows you to change settings of the notebooks.</p>
<p>You may have noticed, that in the beginning of each notebook there is a cell with a comment <code># This cell is tagged parameters</code>.
The cell has been added 'Parameters<code>tag. The template notebooks already contain the tag, 
but you can see [here](https://papermill.readthedocs.io/en/latest/usage-parameterize.html) how to do it on different notebook editors.
In this cell, variables are assigned. What papermill does is, that any parameters given to the</code>execute_notebook` function are listed 
in a new cell right below the one tagged with parameters. The listed parameters will rewrite the default assignments.
This is why you should not do anything else but simple assignments in the parameters cell.</p>
<p>Let's show an example. Let's run the notebook 'model' with and without changing the 'seed'-parameter.
You can then compare the resulting notebooks in <code>results/notebooks</code>.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># run model notebook with default parameters</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">execute_notebook</span><span class="p">(</span>
    <span class="s2">&quot;02_loss.ipynb&quot;</span><span class="p">,</span> <span class="s2">&quot;results/.notebooks/02_loss_default_params.ipynb&quot;</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="p">{}</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># run model notebook with &#39;seed&#39; -parameter changed from 0 to 1</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">execute_notebook</span><span class="p">(</span>
    <span class="s2">&quot;02_loss.ipynb&quot;</span><span class="p">,</span> <span class="s2">&quot;results/.notebooks/02_loss_seed_1.ipynb&quot;</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;seed&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>You can now compare the results.</p>
<p>Copies of the executed notebooks are saved in a hidden folder, so that they don't confuse nbdev.
Notebooks can not be viewed from hidden folders, so you have to move (or copy) them to the results folder to view them.
This may appear a bit unpractical, and we hope to find a more convenient solution in the future (without making custom edits to nbdev).
However, in practice this rarely matters since the location where you save the notebooks can be outside the project folder, and it only serves as a backup
so you probably don't need to view the automatically executed notebooks that often.</p>
<p>How to move the notebooks from one folder to another in shell:</p>

<pre><code># replace mv with cp if you want to copy the files instead of moving
mv results/.notebooks/02_loss_default_params.ipynb results/02_loss_default_params.ipynb
mv results/.notebooks/02_loss_default_params.ipynb results/02_loss_default_params.ipynb

</code></pre>
<p>You can then open the notebooks as usual in your editor. See how changing the seed changes the results?</p>
<p>Now, before you build the modules and docs with <code>nbdev_build_lib &amp;&amp; nbdev_build_docs</code>, remember to delete the notebook files from under results folder:</p>

<pre><code>rm results/02_loss_default_params.ipynb results/02_loss_default_params.ipynb</code></pre>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Static-executable-workflow-with-papermill">Static executable workflow with papermill<a class="anchor-link" href="#Static-executable-workflow-with-papermill"> </a></h2><p>The following script will be written into a python file, that you can run to execute the workflow.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Dynamic-executable-workflow-with-Snakemake">Dynamic executable workflow with Snakemake<a class="anchor-link" href="#Dynamic-executable-workflow-with-Snakemake"> </a></h2><p>The following script will be written into a Snakefile, that you can run to execute the workflow.</p>

</div>
</div>
</div>
</div>
 

